{% extends "base.html" %}
{% block title %}Mood Calendar - YuVA Wellness{% endblock %}

{% block content %}
<div class="mood-page">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 3rem; margin-bottom: 1rem;">
            <i class="fas fa-heart"></i> Mood Calendar
        </h1>
        <p style="color: var(--text-muted); font-size: 1.2rem;">
            Track your emotional journey and discover patterns.
        </p>
    </div>

    <!-- Quick Stats Overview -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-value" id="currentStreak">-</div>
            <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="thisWeekEntries">-</div>
            <div class="stat-label">This Week</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="averageMoodScore">-</div>
            <div class="stat-label">Avg Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="moodTrend">-</div>
            <div class="stat-label">Trend</div>
        </div>
    </div>

    <!-- Mood Assessment Form -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">
                <i class="fas fa-brain"></i> Daily Mood Assessment
            </h3>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button id="quickMoodBtn" class="btn-secondary" onclick="toggleQuickMood()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                    <i class="fas fa-zap"></i> Quick Mood
                </button>
                <div id="assessmentProgress" style="display: none; font-size: 0.9rem; color: var(--text-muted);">
                    <i class="fas fa-clock"></i> <span id="progressText">0/6 completed</span>
                </div>
            </div>
        </div>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 1rem;">
            Answer a few quick questions to help us understand your emotional state today.
        </p>

        <!-- Quick Mood Selection (Hidden by default) -->
        <div id="quickMoodSection" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--info);">
            <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                <i class="fas fa-zap" style="margin-right: 0.5rem; color: var(--info);"></i>
                Quick Mood Log
            </h4>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                Select your current mood quickly without the detailed assessment.
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <button class="quick-mood-btn" onclick="logQuickMood('üòä', 'Happy')" data-mood="üòä">
                    <span style="font-size: 2rem;">üòä</span>
                    <span>Happy</span>
                </button>
                <button class="quick-mood-btn" onclick="logQuickMood('üòå', 'Calm')" data-mood="üòå">
                    <span style="font-size: 2rem;">üòå</span>
                    <span>Calm</span>
                </button>
                <button class="quick-mood-btn" onclick="logQuickMood('üòê', 'Neutral')" data-mood="üòê">
                    <span style="font-size: 2rem;">üòê</span>
                    <span>Neutral</span>
                </button>
                <button class="quick-mood-btn" onclick="logQuickMood('üòî', 'Sad')" data-mood="üòî">
                    <span style="font-size: 2rem;">üòî</span>
                    <span>Sad</span>
                </button>
                <button class="quick-mood-btn" onclick="logQuickMood('üò∞', 'Anxious')" data-mood="üò∞">
                    <span style="font-size: 2rem;">üò∞</span>
                    <span>Anxious</span>
                </button>
                <button class="quick-mood-btn" onclick="logQuickMood('üò´', 'Stressed')" data-mood="üò´">
                    <span style="font-size: 2rem;">üò´</span>
                    <span>Stressed</span>
                </button>
            </div>
        </div>
        
        <!-- Assessment Questions -->
        <div id="assessmentQuestions" style="display: block;">
            <!-- Question 1: Energy & Motivation -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--primary);">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-battery-three-quarters" style="margin-right: 0.5rem; color: var(--primary);"></i>
                    How is your energy and motivation today?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="1" data-value="high" data-score="3" onclick="selectAnswer(1, 'high', this)">
                        <i class="fas fa-rocket"></i> High - Feeling energized and motivated
                    </button>
                    <button class="assessment-btn" data-question="1" data-value="moderate" data-score="2" onclick="selectAnswer(1, 'moderate', this)">
                        <i class="fas fa-walking"></i> Moderate - Steady energy levels
                    </button>
                    <button class="assessment-btn" data-question="1" data-value="low" data-score="1" onclick="selectAnswer(1, 'low', this)">
                        <i class="fas fa-bed"></i> Low - Feeling tired or unmotivated
                    </button>
                </div>
            </div>

            <!-- Question 2: Emotional State -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #fd79a8;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-heart" style="margin-right: 0.5rem; color: #fd79a8;"></i>
                    How would you describe your emotional state?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="2" data-value="positive" data-score="3" onclick="selectAnswer(2, 'positive', this)">
                        <i class="fas fa-smile"></i> Positive - Happy, content, or excited
                    </button>
                    <button class="assessment-btn" data-question="2" data-value="neutral" data-score="2" onclick="selectAnswer(2, 'neutral', this)">
                        <i class="fas fa-meh"></i> Neutral - Calm and balanced
                    </button>
                    <button class="assessment-btn" data-question="2" data-value="challenging" data-score="1" onclick="selectAnswer(2, 'challenging', this)">
                        <i class="fas fa-frown"></i> Challenging - Sad, anxious, or stressed
                    </button>
                </div>
            </div>

            <!-- Question 3: Social Connection -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #00cec9;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-users" style="margin-right: 0.5rem; color: #00cec9;"></i>
                    How connected do you feel to others today?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="3" data-value="connected" data-score="3" onclick="selectAnswer(3, 'connected', this)">
                        <i class="fas fa-handshake"></i> Connected - Feeling supported and social
                    </button>
                    <button class="assessment-btn" data-question="3" data-value="somewhat" data-score="2" onclick="selectAnswer(3, 'somewhat', this)">
                        <i class="fas fa-user-friends"></i> Somewhat - Some social interaction
                    </button>
                    <button class="assessment-btn" data-question="3" data-value="isolated" data-score="1" onclick="selectAnswer(3, 'isolated', this)">
                        <i class="fas fa-user"></i> Isolated - Feeling alone or disconnected
                    </button>
                </div>
            </div>

            <!-- Question 4: Sleep Quality -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #a29bfe;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-moon" style="margin-right: 0.5rem; color: #a29bfe;"></i>
                    How was your sleep last night?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="4" data-value="excellent" data-score="3" onclick="selectAnswer(4, 'excellent', this)">
                        <i class="fas fa-bed"></i> Excellent - Restful and refreshing
                    </button>
                    <button class="assessment-btn" data-question="4" data-value="okay" data-score="2" onclick="selectAnswer(4, 'okay', this)">
                        <i class="fas fa-clock"></i> Okay - Average sleep quality
                    </button>
                    <button class="assessment-btn" data-question="4" data-value="poor" data-score="1" onclick="selectAnswer(4, 'poor', this)">
                        <i class="fas fa-tired"></i> Poor - Restless or insufficient sleep
                    </button>
                </div>
            </div>

            <!-- Question 5: Stress Level -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #e17055;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-thermometer-half" style="margin-right: 0.5rem; color: #e17055;"></i>
                    What's your stress level today?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="5" data-value="low" data-score="3" onclick="selectAnswer(5, 'low', this)">
                        <i class="fas fa-leaf"></i> Low - Feeling calm and relaxed
                    </button>
                    <button class="assessment-btn" data-question="5" data-value="moderate" data-score="2" onclick="selectAnswer(5, 'moderate', this)">
                        <i class="fas fa-balance-scale"></i> Moderate - Some pressure but manageable
                    </button>
                    <button class="assessment-btn" data-question="5" data-value="high" data-score="1" onclick="selectAnswer(5, 'high', this)">
                        <i class="fas fa-fire"></i> High - Feeling overwhelmed or anxious
                    </button>
                </div>
            </div>

            <!-- Question 6: Physical Wellness -->
            <div class="question-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #00b894;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center;">
                    <i class="fas fa-heartbeat" style="margin-right: 0.5rem; color: #00b894;"></i>
                    How do you feel physically today?
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;">
                    <button class="assessment-btn" data-question="6" data-value="great" data-score="3" onclick="selectAnswer(6, 'great', this)">
                        <i class="fas fa-running"></i> Great - Healthy and strong
                    </button>
                    <button class="assessment-btn" data-question="6" data-value="okay" data-score="2" onclick="selectAnswer(6, 'okay', this)">
                        <i class="fas fa-walking"></i> Okay - Normal physical state
                    </button>
                    <button class="assessment-btn" data-question="6" data-value="unwell" data-score="1" onclick="selectAnswer(6, 'unwell', this)">
                        <i class="fas fa-thermometer-full"></i> Unwell - Sick or in discomfort
                    </button>
                </div>
            </div>

            <!-- Optional Note -->
            <div style="margin-bottom: 1.5rem;">
                <label for="assessmentNote" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text);">
                    <i class="fas fa-sticky-note"></i> Additional thoughts (optional)
                </label>
                <textarea 
                    id="assessmentNote" 
                    placeholder="Anything else you'd like to note about your day or feelings..."
                    style="width: 100%; padding: 1rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border-color); min-height: 80px; resize: vertical; font-family: inherit;"
                ></textarea>
            </div>

            <!-- Submit Button -->
            <div style="text-align: center;">
                <button 
                    id="submitAssessment" 
                    class="btn" 
                    onclick="submitMoodAssessment()" 
                    disabled
                    style="background: var(--primary); color: white; padding: 1rem 2rem; font-size: 1.1rem; border-radius: 8px; cursor: not-allowed; opacity: 0.6; transition: all 0.3s ease;"
                >
                    <i class="fas fa-check-circle"></i> Complete Assessment
                </button>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                    Please answer all six questions above
                </p>
            </div>
        </div>

        <!-- Results Display -->
        <div id="assessmentResults" style="display: none; text-align: center; padding: 2rem;">
            <div id="moodResult" style="font-size: 4rem; margin-bottom: 1rem;"></div>
            <h3 id="moodLabel" style="margin-bottom: 1rem; color: var(--text);"></h3>
            <p id="moodInsight" style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.6;"></p>
            <div id="moodRecommendations" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
            <button class="btn" onclick="resetAssessment()" style="background: var(--secondary); color: white; padding: 0.8rem 1.5rem;">
                <i class="fas fa-redo"></i> Take Assessment Again
            </button>
        </div>
        
        <div id="moodMessage" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: 500;"></div>
    </div>

    <!-- Mood Insights -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">
            <i class="fas fa-lightbulb"></i> Today's Insights
        </h3>
        <div id="moodInsights">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div class="insight-card" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--success);">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--success);">
                        <i class="fas fa-chart-line"></i> Mood Pattern
                    </h5>
                    <p id="moodPattern" style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                        Loading pattern analysis...
                    </p>
                </div>
                <div class="insight-card" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--info);">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--info);">
                        <i class="fas fa-clock"></i> Best Time
                    </h5>
                    <p id="bestTime" style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                        Analyzing your optimal times...
                    </p>
                </div>
                <div class="insight-card" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--warning);">
                    <h5 style="margin: 0 0 0.5rem 0; color: var(--warning);">
                        <i class="fas fa-target"></i> Focus Area
                    </h5>
                    <p id="focusArea" style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">
                        Identifying improvement areas...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">
                <i class="fas fa-calendar-alt"></i> This Month's Mood Calendar
            </h3>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button id="calendarViewBtn" class="btn-secondary" onclick="toggleCalendarView()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                    <i class="fas fa-th"></i> <span id="viewText">Grid View</span>
                </button>
                <select id="monthSelector" onchange="changeMonth()" style="padding: 0.5rem; border-radius: 6px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text);">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
        </div>
        
        <!-- Legend -->
        <div style="margin-bottom: 1rem;">
            <h4 style="text-align: center; margin-bottom: 1rem; color: var(--text-muted);">Emotion Categories</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                <div>
                    <h5 style="margin: 0 0 0.5rem 0; color: #00b894;">‚ú® Positive</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; font-size: 0.9rem;">
                        <span>üòä Happy</span> <span>ü•∞ Loved</span> <span>üòå Peaceful</span>
                        <span>ü§ó Grateful</span> <span>üòé Confident</span> <span>ü§© Excited</span>
                    </div>
                </div>
                <div>
                    <h5 style="margin: 0 0 0.5rem 0; color: #74b9ff;">üîµ Neutral</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; font-size: 0.9rem;">
                        <span>üòê Neutral</span> <span>ü§î Thoughtful</span>
                        <span>üò¥ Tired</span> <span>üôÇ Okay</span>
                    </div>
                </div>
                <div>
                    <h5 style="margin: 0 0 0.5rem 0; color: #fdcb6e;">‚ö° Challenging</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; font-size: 0.9rem;">
                        <span>üòî Sad</span> <span>üò∞ Anxious</span> <span>üò´ Stressed</span>
                        <span>üò§ Frustrated</span> <span>üò¢ Crying</span> <span>üò° Angry</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div id="moodCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin: 1rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
        </div>
        
        <!-- Recent History -->
        <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Entries</h4>
        <div id="moodHistory"></div>
    </div>
</div>

<script>
// Enhanced Mood Assessment System
let assessmentAnswers = {};
let currentView = 'grid'; // 'grid' or 'list'
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
const totalQuestions = 6;

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    loadMoodHistory();
    loadMoodCalendar();
    loadMoodStats();
    loadMoodInsights();
    initializeMonthSelector();
});

// Quick Mood Functions
function toggleQuickMood() {
    const quickSection = document.getElementById('quickMoodSection');
    const assessmentSection = document.getElementById('assessmentQuestions');
    const btn = document.getElementById('quickMoodBtn');
    
    if (quickSection.style.display === 'none') {
        quickSection.style.display = 'block';
        assessmentSection.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-list"></i> Full Assessment';
    } else {
        quickSection.style.display = 'none';
        assessmentSection.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-zap"></i> Quick Mood';
    }
}

async function logQuickMood(emoji, label) {
    // Find the clicked button and show loading state
    const clickedButton = event.target.closest('.quick-mood-btn');
    const originalContent = clickedButton.innerHTML;
    
    // Show loading state
    clickedButton.innerHTML = `
        <span style="font-size: 2rem;">‚è≥</span>
        <span>Logging...</span>
    `;
    clickedButton.disabled = true;
    clickedButton.style.opacity = '0.7';
    
    try {
        const response = await fetch('/api/mood/log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                mood: emoji,
                note: `Quick mood: ${label}`
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show success state
            clickedButton.innerHTML = `
                <span style="font-size: 2rem;">‚úÖ</span>
                <span>Logged!</span>
            `;
            clickedButton.style.background = 'var(--success)';
            clickedButton.style.color = 'white';
            clickedButton.style.borderColor = 'var(--success)';
            
            // Show success message
            showMessage(`Quick mood logged: ${emoji} ${label}! üéâ`, 'success');
            
            // Update other components
            loadMoodHistory();
            loadMoodCalendar();
            loadMoodStats();
            loadMoodInsights();
            
            // Reset button after 2 seconds
            setTimeout(() => {
                clickedButton.innerHTML = originalContent;
                clickedButton.disabled = false;
                clickedButton.style.opacity = '1';
                clickedButton.style.background = '';
                clickedButton.style.color = '';
                clickedButton.style.borderColor = '';
            }, 2000);
            
        } else {
            throw new Error(result.error || 'Failed to log mood');
        }
    } catch (error) {
        // Show error state
        clickedButton.innerHTML = `
            <span style="font-size: 2rem;">‚ùå</span>
            <span>Error</span>
        `;
        clickedButton.style.background = 'var(--danger)';
        clickedButton.style.color = 'white';
        clickedButton.style.borderColor = 'var(--danger)';
        
        showMessage('Failed to log quick mood. Please try again.', 'error');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            clickedButton.innerHTML = originalContent;
            clickedButton.disabled = false;
            clickedButton.style.opacity = '1';
            clickedButton.style.background = '';
            clickedButton.style.color = '';
            clickedButton.style.borderColor = '';
        }, 2000);
    }
}

// Stats Functions
async function loadMoodStats() {
    try {
        const response = await fetch('/api/mood/entries');
        const entries = await response.json();
        
        if (entries.length === 0) {
            document.getElementById('currentStreak').textContent = '0';
            document.getElementById('thisWeekEntries').textContent = '0';
            document.getElementById('averageMoodScore').textContent = 'N/A';
            document.getElementById('moodTrend').textContent = 'üìä';
            return;
        }
        
        // Calculate streak
        const streak = calculateStreak(entries);
        document.getElementById('currentStreak').textContent = streak;
        
        // Calculate this week's entries
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const thisWeekEntries = entries.filter(entry => 
            new Date(entry.date) >= weekAgo
        ).length;
        document.getElementById('thisWeekEntries').textContent = thisWeekEntries;
        
        // Calculate average mood score
        const avgScore = calculateAverageMoodScore(entries);
        document.getElementById('averageMoodScore').textContent = avgScore;
        
        // Calculate trend
        const trend = calculateMoodTrend(entries);
        document.getElementById('moodTrend').textContent = trend;
        
    } catch (error) {
        console.error('Error loading mood stats:', error);
    }
}

function calculateStreak(entries) {
    if (entries.length === 0) return 0;
    
    const today = new Date();
    let streak = 0;
    let currentDate = new Date(today);
    
    // Sort entries by date (newest first)
    const sortedEntries = [...entries].sort((a, b) => 
        new Date(b.date) - new Date(a.date)
    );
    
    for (let i = 0; i < 30; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const hasEntry = sortedEntries.some(entry => entry.date === dateStr);
        
        if (hasEntry) {
            streak++;
        } else if (i > 0) {
            break;
        }
        
        currentDate.setDate(currentDate.getDate() - 1);
    }
    
    return streak;
}

function calculateAverageMoodScore(entries) {
    if (entries.length === 0) return 'N/A';
    
    const moodScores = {
        'üòä': 5, 'ü•∞': 5, 'üòå': 4, 'ü§ó': 5, 'üòé': 5, 'ü§©': 5, 'üôÇ': 4,
        'üòê': 3, 'ü§î': 3, 'üò¥': 2,
        'üòî': 2, 'üò∞': 1, 'üò´': 1, 'üò§': 2, 'üò¢': 1, 'üò°': 1, 'üòû': 1
    };
    
    let totalScore = 0;
    let validEntries = 0;
    
    entries.forEach(entry => {
        if (moodScores[entry.mood]) {
            totalScore += moodScores[entry.mood];
            validEntries++;
        }
    });
    
    return validEntries > 0 ? (totalScore / validEntries).toFixed(1) : 'N/A';
}

function calculateMoodTrend(entries) {
    if (entries.length < 7) return 'üìä';
    
    const recent = entries.slice(0, 7);
    const older = entries.slice(7, 14);
    
    const recentAvg = calculateAverageMoodScore(recent);
    const olderAvg = calculateAverageMoodScore(older);
    
    if (recentAvg === 'N/A' || olderAvg === 'N/A') return 'üìä';
    
    const diff = parseFloat(recentAvg) - parseFloat(olderAvg);
    
    if (diff > 0.5) return 'üìà';
    else if (diff < -0.5) return 'üìâ';
    else return '‚û°Ô∏è';
}

// Insights Functions
async function loadMoodInsights() {
    try {
        const response = await fetch('/api/mood/entries');
        const entries = await response.json();
        
        if (entries.length === 0) {
            document.getElementById('moodPattern').textContent = 'Start logging moods to see patterns';
            document.getElementById('bestTime').textContent = 'Need more data to analyze';
            document.getElementById('focusArea').textContent = 'Keep tracking for insights';
            return;
        }
        
        // Analyze patterns
        const pattern = analyzeMoodPattern(entries);
        document.getElementById('moodPattern').textContent = pattern;
        
        // Best time analysis (placeholder - would need timestamp data)
        document.getElementById('bestTime').textContent = 'Morning logging shows consistency';
        
        // Focus area based on recent moods
        const focusArea = analyzeFocusArea(entries);
        document.getElementById('focusArea').textContent = focusArea;
        
    } catch (error) {
        console.error('Error loading insights:', error);
    }
}

function analyzeMoodPattern(entries) {
    if (entries.length < 7) return 'Need more data for pattern analysis';
    
    const recent = entries.slice(0, 7);
    const positiveCount = recent.filter(e => 
        ['üòä', 'ü•∞', 'üòå', 'ü§ó', 'üòé', 'ü§©', 'üôÇ'].includes(e.mood)
    ).length;
    
    const percentage = (positiveCount / recent.length) * 100;
    
    if (percentage >= 70) return 'Strong positive trend this week';
    else if (percentage >= 50) return 'Balanced mood pattern';
    else if (percentage >= 30) return 'Mixed emotions, some challenges';
    else return 'Difficult period, consider support';
}

function analyzeFocusArea(entries) {
    if (entries.length === 0) return 'Start tracking for personalized insights';
    
    const recent = entries.slice(0, 5);
    const stressfulMoods = recent.filter(e => 
        ['üò∞', 'üò´', 'üò§', 'üò°'].includes(e.mood)
    ).length;
    
    if (stressfulMoods >= 3) return 'Stress management and relaxation';
    
    const lowEnergyMoods = recent.filter(e => 
        ['üò¥', 'üòî', 'üòû'].includes(e.mood)
    ).length;
    
    if (lowEnergyMoods >= 3) return 'Energy and motivation building';
    
    return 'Maintaining current positive habits';
}

// Calendar Functions
function toggleCalendarView() {
    const btn = document.getElementById('calendarViewBtn');
    const viewText = document.getElementById('viewText');
    
    if (currentView === 'grid') {
        currentView = 'list';
        btn.innerHTML = '<i class="fas fa-calendar"></i> <span id="viewText">Calendar View</span>';
        showListView();
    } else {
        currentView = 'grid';
        btn.innerHTML = '<i class="fas fa-th"></i> <span id="viewText">Grid View</span>';
        loadMoodCalendar();
    }
}

function showListView() {
    const calendarDiv = document.getElementById('moodCalendar');
    
    fetch('/api/mood/entries')
        .then(response => response.json())
        .then(entries => {
            if (entries.length === 0) {
                calendarDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No mood entries yet.</p>';
                return;
            }
            
            const groupedEntries = {};
            entries.forEach(entry => {
                const date = entry.date;
                if (!groupedEntries[date] || entry.id > groupedEntries[date].id) {
                    groupedEntries[date] = entry;
                }
            });
            
            const sortedEntries = Object.values(groupedEntries).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            calendarDiv.innerHTML = sortedEntries.slice(0, 10).map(entry => `
                <div style="display: flex; align-items: center; padding: 1rem; margin: 0.5rem 0; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--primary);">
                    <span style="font-size: 2rem; margin-right: 1rem;">${entry.mood}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text);">${new Date(entry.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        ${entry.note ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">${entry.note}</div>` : ''}
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            calendarDiv.innerHTML = '<p style="color: #e17055;">Failed to load mood history</p>';
        });
}

function initializeMonthSelector() {
    const selector = document.getElementById('monthSelector');
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const currentDate = new Date();
    const currentMonthIndex = currentDate.getMonth();
    const currentYearValue = currentDate.getFullYear();
    
    // Add current year and previous year options
    for (let year = currentYearValue; year >= currentYearValue - 1; year--) {
        for (let month = 11; month >= 0; month--) {
            if (year === currentYearValue && month > currentMonthIndex) continue;
            
            const option = document.createElement('option');
            option.value = `${year}-${month}`;
            option.textContent = `${months[month]} ${year}`;
            
            if (year === currentYearValue && month === currentMonthIndex) {
                option.selected = true;
            }
            
            selector.appendChild(option);
        }
    }
}

function changeMonth() {
    const selector = document.getElementById('monthSelector');
    const [year, month] = selector.value.split('-');
    currentYear = parseInt(year);
    currentMonth = parseInt(month);
    
    if (currentView === 'grid') {
        loadMoodCalendar();
    } else {
        showListView();
    }
}

function showMessage(message, type) {
    const messageDiv = document.getElementById('moodMessage');
    if (!messageDiv) return;
    
    messageDiv.textContent = message;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    // Set background color based on type
    if (type === 'success') {
        messageDiv.style.background = '#00b894';
        messageDiv.style.color = 'white';
    } else if (type === 'error') {
        messageDiv.style.background = '#e17055';
        messageDiv.style.color = 'white';
    }
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

function selectAnswer(questionId, value, buttonElement) {
    // Store the answer with its score
    const score = parseInt(buttonElement.getAttribute('data-score'));
    assessmentAnswers[questionId] = {
        value: value,
        score: score
    };
    
    // Update button states for this question
    const questionCard = buttonElement.closest('.question-card');
    const allButtons = questionCard.querySelectorAll('.assessment-btn');
    
    allButtons.forEach(btn => {
        btn.classList.remove('selected');
        btn.style.background = '';
        btn.style.color = '';
        btn.style.borderColor = '';
    });
    
    // Highlight selected button
    buttonElement.classList.add('selected');
    buttonElement.style.background = 'var(--primary)';
    buttonElement.style.color = 'white';
    buttonElement.style.borderColor = 'var(--primary)';
    
    // Check if all questions are answered
    updateSubmitButton();
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitAssessment');
    const progressDiv = document.getElementById('assessmentProgress');
    const progressText = document.getElementById('progressText');
    const answeredCount = Object.keys(assessmentAnswers).length;
    
    // Update progress display
    if (answeredCount > 0) {
        progressDiv.style.display = 'block';
        progressText.textContent = `${answeredCount}/${totalQuestions} completed`;
    } else {
        progressDiv.style.display = 'none';
    }
    
    if (answeredCount === totalQuestions) {
        submitBtn.disabled = false;
        submitBtn.style.cursor = 'pointer';
        submitBtn.style.opacity = '1';
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Complete Assessment';
    } else {
        submitBtn.disabled = true;
        submitBtn.style.cursor = 'not-allowed';
        submitBtn.style.opacity = '0.6';
        submitBtn.innerHTML = `<i class="fas fa-check-circle"></i> Complete Assessment (${answeredCount}/${totalQuestions})`;
    }
}

function predictMood() {
    // Calculate total score (max 18, min 6)
    let totalScore = 0;
    let weights = {
        1: 1.2, // Energy & Motivation - higher weight
        2: 1.5, // Emotional State - highest weight
        3: 1.0, // Social Connection
        4: 1.1, // Sleep Quality
        5: 1.3, // Stress Level - higher weight (inverted)
        6: 1.0  // Physical Wellness
    };
    
    let weightedScore = 0;
    let totalWeight = 0;
    
    for (let questionId in assessmentAnswers) {
        const answer = assessmentAnswers[questionId];
        const weight = weights[questionId];
        weightedScore += answer.score * weight;
        totalWeight += weight;
    }
    
    // Normalize to 0-1 scale
    const normalizedScore = weightedScore / (totalWeight * 3);
    
    // Determine mood category and specific mood
    let moodData = getMoodFromScore(normalizedScore, assessmentAnswers);
    
    return moodData;
}

function getMoodFromScore(score, answers) {
    // Analyze specific patterns in answers
    const energyScore = answers[1].score;
    const emotionalScore = answers[2].score;
    const socialScore = answers[3].score;
    const sleepScore = answers[4].score;
    const stressScore = answers[5].score;
    const physicalScore = answers[6].score;
    
    // High overall score (0.8+)
    if (score >= 0.8) {
        if (energyScore === 3 && emotionalScore === 3) {
            return {
                emoji: 'ü§©',
                label: 'Excited & Energized',
                category: 'positive',
                insight: 'You\'re having an amazing day! Your high energy and positive emotions are a powerful combination.',
                recommendations: [
                    'Channel this energy into creative projects or goals',
                    'Share your positive vibes with others',
                    'Consider what contributed to this great mood for future reference'
                ]
            };
        } else if (socialScore === 3 && emotionalScore === 3) {
            return {
                emoji: 'ü•∞',
                label: 'Happy & Connected',
                category: 'positive',
                insight: 'You\'re feeling loved and socially fulfilled. Connection with others is boosting your mood significantly.',
                recommendations: [
                    'Reach out to someone you care about',
                    'Plan social activities for the coming days',
                    'Practice gratitude for your relationships'
                ]
            };
        } else {
            return {
                emoji: 'üòä',
                label: 'Very Happy',
                category: 'positive',
                insight: 'You\'re in a great mood today! Multiple aspects of your wellbeing are aligned positively.',
                recommendations: [
                    'Take a moment to appreciate this positive state',
                    'Engage in activities you enjoy',
                    'Consider journaling about what\'s going well'
                ]
            };
        }
    }
    
    // Good score (0.65-0.8)
    else if (score >= 0.65) {
        if (stressScore === 3 && sleepScore >= 2) {
            return {
                emoji: 'üòå',
                label: 'Peaceful & Calm',
                category: 'positive',
                insight: 'You\'re feeling balanced and at peace. Low stress and good rest are serving you well.',
                recommendations: [
                    'Maintain your current self-care routine',
                    'Practice mindfulness or meditation',
                    'Enjoy some quiet, reflective time'
                ]
            };
        } else {
            return {
                emoji: 'üôÇ',
                label: 'Content & Stable',
                category: 'positive',
                insight: 'You\'re feeling generally positive and stable. Things are going well overall.',
                recommendations: [
                    'Continue with your current routine',
                    'Look for small ways to boost your mood further',
                    'Connect with friends or family'
                ]
            };
        }
    }
    
    // Moderate score (0.45-0.65)
    else if (score >= 0.45) {
        if (sleepScore === 1 || physicalScore === 1) {
            return {
                emoji: 'üò¥',
                label: 'Tired but Okay',
                category: 'neutral',
                insight: 'You\'re managing despite feeling physically drained. Rest and self-care could help.',
                recommendations: [
                    'Prioritize getting quality sleep tonight',
                    'Take breaks throughout the day',
                    'Consider light exercise or stretching'
                ]
            };
        } else if (socialScore === 1) {
            return {
                emoji: 'ü§î',
                label: 'Thoughtful & Introspective',
                category: 'neutral',
                insight: 'You\'re feeling somewhat isolated but stable. Some social connection might help.',
                recommendations: [
                    'Reach out to a friend or family member',
                    'Join a social activity or community event',
                    'Practice self-compassion'
                ]
            };
        } else {
            return {
                emoji: 'üòê',
                label: 'Neutral & Balanced',
                category: 'neutral',
                insight: 'You\'re feeling steady and balanced, neither particularly high nor low.',
                recommendations: [
                    'This is a good baseline - maintain your routine',
                    'Look for small positive activities',
                    'Check in with yourself regularly'
                ]
            };
        }
    }
    
    // Lower score (0.3-0.45)
    else if (score >= 0.3) {
        if (stressScore === 1 && emotionalScore === 1) {
            return {
                emoji: 'üò∞',
                label: 'Anxious & Overwhelmed',
                category: 'challenging',
                insight: 'You\'re dealing with significant stress and emotional challenges. It\'s important to be gentle with yourself.',
                recommendations: [
                    'Practice deep breathing or meditation',
                    'Break large tasks into smaller, manageable steps',
                    'Consider talking to someone you trust',
                    'Engage in calming activities'
                ]
            };
        } else if (energyScore === 1 && sleepScore === 1) {
            return {
                emoji: 'üò´',
                label: 'Exhausted & Drained',
                category: 'challenging',
                insight: 'You\'re feeling physically and mentally drained. Rest and recovery should be your priority.',
                recommendations: [
                    'Prioritize sleep and rest',
                    'Reduce non-essential commitments today',
                    'Practice gentle self-care',
                    'Consider a short nap if possible'
                ]
            };
        } else {
            return {
                emoji: 'üòî',
                label: 'Sad & Low',
                category: 'challenging',
                insight: 'You\'re experiencing some difficult emotions today. Remember that this is temporary.',
                recommendations: [
                    'Be patient and kind with yourself',
                    'Engage in gentle, comforting activities',
                    'Reach out for support if needed',
                    'Focus on basic self-care'
                ]
            };
        }
    }
    
    // Very low score (below 0.3)
    else {
        if (emotionalScore === 1 && stressScore === 1) {
            return {
                emoji: 'üò¢',
                label: 'Struggling & Distressed',
                category: 'challenging',
                insight: 'You\'re going through a particularly difficult time. Please remember that support is available.',
                recommendations: [
                    'Consider reaching out to a mental health professional',
                    'Contact a trusted friend or family member',
                    'Focus on basic needs: food, water, rest',
                    'Use crisis resources if you\'re in immediate distress',
                    'Remember: this difficult time will pass'
                ]
            };
        } else {
            return {
                emoji: 'üòû',
                label: 'Very Low & Struggling',
                category: 'challenging',
                insight: 'Multiple areas of your wellbeing are challenging right now. Please be extra gentle with yourself.',
                recommendations: [
                    'Prioritize basic self-care and rest',
                    'Reach out for support from friends, family, or professionals',
                    'Take things one moment at a time',
                    'Consider professional mental health support'
                ]
            };
        }
    }
}

async function submitMoodAssessment() {
    if (Object.keys(assessmentAnswers).length !== totalQuestions) {
        alert('Please answer all questions before submitting.');
        return;
    }
    
    // Predict mood based on answers
    const moodData = predictMood();
    
    // Get additional note
    const note = document.getElementById('assessmentNote').value;
    
    // Create detailed note with assessment data
    const assessmentSummary = Object.entries(assessmentAnswers).map(([q, a]) => {
        const questionLabels = {
            1: 'Energy',
            2: 'Emotion',
            3: 'Social',
            4: 'Sleep',
            5: 'Stress',
            6: 'Physical'
        };
        return `${questionLabels[q]}: ${a.value}`;
    }).join(', ');
    
    const enhancedNote = note ? 
        `${note} | Assessment: ${assessmentSummary}` : 
        `Assessment: ${assessmentSummary}`;
    
    try {
        // Log the predicted mood
        const response = await fetch('/api/mood/log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                mood: moodData.emoji,
                note: enhancedNote
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show results
            showAssessmentResults(moodData);
            
            // Refresh calendar and history
            loadMoodHistory();
            loadMoodCalendar();
        } else {
            throw new Error(result.error || 'Failed to log mood');
        }
    } catch (error) {
        console.error('Error submitting assessment:', error);
        const messageDiv = document.getElementById('moodMessage');
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#e17055';
        messageDiv.style.color = 'white';
        messageDiv.textContent = 'Failed to submit assessment. Please try again.';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    }
}

function showAssessmentResults(moodData) {
    // Hide questions, show results
    document.getElementById('assessmentQuestions').style.display = 'none';
    document.getElementById('assessmentResults').style.display = 'block';
    
    // Update result display
    document.getElementById('moodResult').textContent = moodData.emoji;
    document.getElementById('moodLabel').textContent = moodData.label;
    document.getElementById('moodInsight').textContent = moodData.insight;
    
    // Show recommendations
    const recommendationsDiv = document.getElementById('moodRecommendations');
    recommendationsDiv.innerHTML = `
        <h4 style="margin: 0 0 1rem 0; color: var(--text);">
            <i class="fas fa-lightbulb"></i> Personalized Recommendations
        </h4>
        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text);">
            ${moodData.recommendations.map(rec => `<li style="margin-bottom: 0.5rem;">${rec}</li>`).join('')}
        </ul>
    `;
    
    // Show success message
    const messageDiv = document.getElementById('moodMessage');
    messageDiv.style.display = 'block';
    messageDiv.style.background = '#00b894';
    messageDiv.style.color = 'white';
    messageDiv.textContent = 'Mood assessment completed successfully! üéâ';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

function resetAssessment() {
    // Clear answers
    assessmentAnswers = {};
    
    // Reset all buttons
    document.querySelectorAll('.assessment-btn').forEach(btn => {
        btn.classList.remove('selected');
        btn.style.background = '';
        btn.style.color = '';
        btn.style.borderColor = '';
    });
    
    // Clear note
    document.getElementById('assessmentNote').value = '';
    
    // Reset submit button
    updateSubmitButton();
    
    // Show questions, hide results
    document.getElementById('assessmentQuestions').style.display = 'block';
    document.getElementById('assessmentResults').style.display = 'none';
}

// Legacy functions for backward compatibility
async function logMood(mood) {
    const note = document.getElementById('moodNote').value;
    const intensity = document.getElementById('moodIntensity').value;
    const messageDiv = document.getElementById('moodMessage');
    
    // Create enhanced note with intensity
    const enhancedNote = note ? `${note} (Intensity: ${intensity}/10)` : `Intensity: ${intensity}/10`;
    
    try {
        const response = await fetch('/api/mood/log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mood: mood, note: enhancedNote})
        });
        
        const result = await response.json();
        
        if (response.ok && result.message) {
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#00b894';
            messageDiv.style.color = 'white';
            
            // Show different message based on whether it was updated or new
            if (result.updated) {
                messageDiv.textContent = 'Mood updated for today! üîÑ';
            } else {
                messageDiv.textContent = 'Mood logged successfully! üéâ';
            }
            
            document.getElementById('moodNote').value = '';
            document.getElementById('moodIntensity').value = '5';
            document.getElementById('intensityValue').textContent = '5';
            loadMoodHistory();
            loadMoodCalendar();
        } else {
            throw new Error(result.error || 'Failed to log mood');
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#e17055';
        messageDiv.style.color = 'white';
        messageDiv.textContent = 'Failed to log mood. Please try again.';
    }
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 3000);
}

async function loadMoodHistory() {
    try {
        const response = await fetch('/api/mood/entries');
        const entries = await response.json();
        
        const historyDiv = document.getElementById('moodHistory');
        
        if (entries.length === 0) {
            historyDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No mood entries yet. Start logging your mood!</p>';
            return;
        }
        
        // Group entries by date and keep only the most recent for each day
        const entriesByDate = {};
        entries.forEach(entry => {
            const date = entry.date;
            if (!entriesByDate[date] || entry.id > entriesByDate[date].id) {
                entriesByDate[date] = entry;
            }
        });
        
        // Convert back to array and sort by date (most recent first)
        const uniqueEntries = Object.values(entriesByDate).sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        historyDiv.innerHTML = uniqueEntries.slice(0, 5).map(entry => `
            <div style="border: 1px solid var(--border-color); padding: 1rem; margin: 1rem 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="font-size: 1.5rem; margin-right: 1rem;">${entry.mood || 'üòä'}</span>
                    <span style="color: var(--text-muted);">${entry.date}</span>
                    ${entry.note ? `<p style="margin: 0.5rem 0 0 0; font-style: italic;">"${entry.note}"</p>` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        document.getElementById('moodHistory').innerHTML = '<p style="color: #e17055;">Failed to load mood history</p>';
    }
}

function loadMoodCalendar() {
    const calendarDiv = document.getElementById('moodCalendar');
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Clear calendar
    calendarDiv.innerHTML = '';
    
    // Get first day and days in month
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const headerDiv = document.createElement('div');
        headerDiv.style.cssText = 'padding: 0.5rem; text-align: center; font-weight: bold; color: var(--text-muted); font-size: 0.8rem;';
        headerDiv.textContent = day;
        calendarDiv.appendChild(headerDiv);
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        calendarDiv.appendChild(emptyDiv);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
        
        dayDiv.style.cssText = `
            aspect-ratio: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 60px;
            ${isToday ? 'border-color: var(--primary); border-width: 2px;' : ''}
        `;
        
        dayDiv.innerHTML = `
            <div style="font-size: 0.8rem; font-weight: 500;">${day}</div>
            <div id="mood-${day}" style="font-size: 1.2rem; margin-top: 2px;"></div>
            ${isToday ? '<div style="position: absolute; top: 2px; right: 2px; font-size: 0.6rem; color: var(--primary); font-weight: 600;">Today</div>' : ''}
        `;
        
        calendarDiv.appendChild(dayDiv);
    }
    
    // Load mood data
    loadMoodDataForCalendar();
}

async function loadMoodDataForCalendar() {
    try {
        const response = await fetch('/api/mood/entries');
        const entries = await response.json();
        
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        // Group entries by date (only keep the most recent for each day)
        const moodsByDate = {};
        
        entries.forEach(entry => {
            const entryDate = new Date(entry.date);
            const day = entryDate.getDate();
            const month = entryDate.getMonth();
            const year = entryDate.getFullYear();
            
            if (month === currentMonth && year === currentYear) {
                const dateKey = `${year}-${month}-${day}`;
                
                // Only keep the most recent entry for each day (entries are ordered by ID desc)
                if (!moodsByDate[dateKey]) {
                    moodsByDate[dateKey] = entry;
                }
            }
        });
        
        // Update calendar with mood data
        Object.values(moodsByDate).forEach(entry => {
            const entryDate = new Date(entry.date);
            const day = entryDate.getDate();
            
            const moodDiv = document.getElementById(`mood-${day}`);
            if (moodDiv) {
                moodDiv.textContent = entry.mood || 'üòä';
                
                // Add background color based on emotion category
                const parentDiv = moodDiv.parentElement;
                let bgColor = '';
                const mood = entry.mood || 'üòä';
                
                // Positive emotions - green shades
                if (mood.includes('üòä') || mood.includes('ü•∞') || mood.includes('üòå') || 
                    mood.includes('ü§ó') || mood.includes('üòé') || mood.includes('ü§©')) {
                    bgColor = 'rgba(0, 184, 148, 0.15)';
                }
                // Neutral emotions - blue shades
                else if (mood.includes('üòê') || mood.includes('ü§î') || mood.includes('üò¥') || mood.includes('üôÇ')) {
                    bgColor = 'rgba(116, 185, 255, 0.15)';
                }
                // Challenging emotions - warm shades
                else if (mood.includes('üòî') || mood.includes('üò∞') || mood.includes('üò´') || 
                         mood.includes('üò§') || mood.includes('üò¢') || mood.includes('üò°')) {
                    bgColor = 'rgba(253, 203, 110, 0.15)';
                }
                else {
                    bgColor = 'rgba(0, 184, 148, 0.1)'; // Default to positive
                }
                
                parentDiv.style.background = bgColor;
                
                if (entry.note) {
                    parentDiv.title = `${entry.mood || 'üòä'} - ${entry.note}`;
                } else {
                    parentDiv.title = entry.mood || 'üòä';
                }
            }
        });
        
    } catch (error) {
        console.error('Failed to load mood data for calendar:', error);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadMoodHistory();
    loadMoodCalendar();
});
</script>

{% endblock %}