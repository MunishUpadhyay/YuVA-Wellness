{% extends "base.html" %}
{% block title %}Wellness Analytics - YuVA Wellness{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2>üìä Wellness Analytics</h2>
            <p style="color: var(--text-muted); margin: 0;">AI-powered insights into your mental wellness journey.</p>
        </div>
        <button onclick="refreshAnalytics()" class="btn" style="background: var(--primary); color: white;">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    
    <!-- Risk Assessment -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>üõ°Ô∏è Risk Assessment</h3>
        <div id="riskContent">
            <div class="loading">Loading risk assessment...</div>
        </div>
    </div>
    
    <!-- Mood Trends -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>üìà Mood Trends</h3>
        <div id="trendsContent">
            <div class="loading">Loading mood trends...</div>
        </div>
    </div>
    
    <!-- Patterns -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">üîç Detected Patterns</h3>
            <button id="advancedPatternsBtn" class="btn-secondary" onclick="toggleAdvancedPatterns()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                <i class="fas fa-brain"></i> <span id="advancedText">Advanced Insights</span>
            </button>
        </div>
        <div id="patternsContent">
            <div class="loading">Loading patterns...</div>
        </div>
        
        <!-- Advanced Patterns Section -->
        <div id="advancedPatternsSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
            <h4 style="margin-bottom: 1rem; color: var(--text);">
                <i class="fas fa-brain"></i> Advanced Pattern Analysis
            </h4>
            <div id="advancedPatternsContent">
                <div class="loading">Loading advanced insights...</div>
            </div>
        </div>
    </div>
    
    <!-- Recommendations -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>üí° Personalized Recommendations</h3>
        <div id="recommendationsContent">
            <div class="loading">Loading recommendations...</div>
        </div>
    </div>
</div>

<script>
async function loadRiskAssessment() {
    try {
        const response = await fetch('/api/analytics/risk-assessment');
        const data = await response.json();
        
        const riskContent = document.getElementById('riskContent');
        const riskClass = data.level || 'low';
        
        riskContent.innerHTML = `
            <div class="risk-level ${riskClass}" style="padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid; background: var(--bg-secondary);">
                <h4 style="margin: 0 0 0.5rem 0; color: ${getRiskColor(riskClass)};">
                    ${getRiskIcon(riskClass)} ${data.level.toUpperCase()} RISK LEVEL
                </h4>
                <p>${data.message}</p>
                ${data.factors && data.factors.length > 0 ? `
                    <ul>
                        ${data.factors.map(factor => `<li>${factor}</li>`).join('')}
                    </ul>
                ` : ''}
            </div>
        `;
    } catch (error) {
        document.getElementById('riskContent').innerHTML = '<p style="color: #e74c3c;">Failed to load risk assessment</p>';
    }
}

async function loadMoodTrends() {
    try {
        const response = await fetch('/api/analytics/mood-trends');
        const data = await response.json();
        
        const trendsContent = document.getElementById('trendsContent');
        
        // Main trend display
        let trendsHTML = `
            <div style="margin: 1rem 0; padding: 1.5rem; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--primary);">
                <h4 style="color: var(--primary); margin: 0 0 0.5rem 0; display: flex; align-items: center;">
                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                    Overall Trend: ${data.overall_trend}
                </h4>
                <p style="margin-bottom: 1rem;">${data.description}</p>
                <div style="width: 100%; height: 24px; background: var(--bg-tertiary); border-radius: 12px; overflow: hidden; margin: 1rem 0;">
                    <div style="height: 100%; background: linear-gradient(90deg, #e17055, #fdcb6e, #00b894); width: ${data.trend_percentage}%; transition: width 1s ease;"></div>
                </div>
                <p style="font-size: 0.9rem; color: var(--text-muted);">Trend Score: ${data.trend_percentage}% | Total Entries: ${data.total_entries || 0}</p>
            </div>
        `;
        
        // Weekly breakdown
        if (data.weekly_breakdown && data.weekly_breakdown.length > 0) {
            trendsHTML += `
                <div style="margin: 1.5rem 0;">
                    <h5 style="color: var(--text); margin-bottom: 1rem;">
                        <i class="fas fa-calendar-week"></i> Weekly Breakdown
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${data.weekly_breakdown.map(week => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">${week.week}</div>
                                <div style="font-size: 1.5rem; color: var(--primary); margin-bottom: 0.25rem;">${week.average_score}/5</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${week.entries_count} entries</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${week.date_range}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Assessment insights
        if (data.assessment_insights && Object.keys(data.assessment_insights).length > 0) {
            trendsHTML += `
                <div style="margin: 1.5rem 0;">
                    <h5 style="color: var(--text); margin-bottom: 1rem;">
                        <i class="fas fa-brain"></i> Assessment Insights
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        ${Object.entries(data.assessment_insights).map(([category, insight]) => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${getCategoryColor(category)};">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem; text-transform: capitalize;">
                                    ${getCategoryIcon(category)} ${category}
                                </div>
                                <div style="font-size: 1.2rem; color: ${getCategoryColor(category)}; margin-bottom: 0.25rem;">
                                    ${insight.average}/3
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    ${insight.trend} ‚Ä¢ ${insight.count} assessments
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Mood distribution
        if (data.mood_distribution && Object.keys(data.mood_distribution).length > 0) {
            const sortedMoods = Object.entries(data.mood_distribution)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            trendsHTML += `
                <div style="margin: 1.5rem 0;">
                    <h5 style="color: var(--text); margin-bottom: 1rem;">
                        <i class="fas fa-chart-pie"></i> Most Common Moods
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                        ${sortedMoods.map(([mood, count]) => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">${mood}</div>
                                <div style="font-weight: 600; color: var(--text);">${count}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">times</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        trendsContent.innerHTML = trendsHTML;
    } catch (error) {
        document.getElementById('trendsContent').innerHTML = '<p style="color: #e74c3c;">Failed to load mood trends</p>';
    }
}

function getCategoryColor(category) {
    const colors = {
        'energy': '#00b894',
        'stress': '#e17055',
        'sleep': '#a29bfe',
        'social': '#00cec9',
        'emotion': '#fd79a8',
        'physical': '#fdcb6e'
    };
    return colors[category] || '#74b9ff';
}

function getCategoryIcon(category) {
    const icons = {
        'energy': '‚ö°',
        'stress': 'üå°Ô∏è',
        'sleep': 'üò¥',
        'social': 'üë•',
        'emotion': '‚ù§Ô∏è',
        'physical': 'üí™'
    };
    return icons[category] || 'üìä';
}

async function loadPatterns() {
    try {
        const response = await fetch('/api/analytics/patterns');
        const data = await response.json();
        
        const patternsContent = document.getElementById('patternsContent');
        
        if (data.patterns && data.patterns.length > 0) {
            patternsContent.innerHTML = `
                <div style="margin: 1rem 0;">
                    <ul style="list-style: none; margin: 0; padding: 0;">
                        ${data.patterns.map(pattern => `
                            <li style="margin: 0.5rem 0; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--primary);">
                                üî∏ ${pattern}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        } else {
            patternsContent.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No patterns detected yet. Keep logging your moods and journal entries!</p>';
        }
    } catch (error) {
        document.getElementById('patternsContent').innerHTML = '<p style="color: #e74c3c;">Failed to load patterns</p>';
    }
}

async function loadRecommendations() {
    try {
        const response = await fetch('/api/analytics/recommendations');
        const data = await response.json();
        
        const recommendationsContent = document.getElementById('recommendationsContent');
        
        if (data.recommendations && data.recommendations.length > 0) {
            recommendationsContent.innerHTML = `
                <div style="margin: 1rem 0;">
                    <ul style="list-style: none; margin: 0; padding: 0;">
                        ${data.recommendations.map(rec => `
                            <li style="margin: 0.5rem 0; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--primary);">
                                ‚ú® ${rec}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        } else {
            recommendationsContent.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No recommendations available yet.</p>';
        }
    } catch (error) {
        document.getElementById('recommendationsContent').innerHTML = '<p style="color: #e74c3c;">Failed to load recommendations</p>';
    }
}

function getRiskColor(level) {
    switch(level) {
        case 'low': return '#00b894';
        case 'medium': return '#fdcb6e';
        case 'high': return '#e17055';
        default: return '#00b894';
    }
}

function getRiskIcon(level) {
    switch(level) {
        case 'low': return 'üü¢';
        case 'medium': return 'üü°';
        case 'high': return 'üî¥';
        default: return 'üü¢';
    }
}

async function refreshAnalytics() {
    // Show loading states
    document.getElementById('riskContent').innerHTML = '<div class="loading">Loading risk assessment...</div>';
    document.getElementById('trendsContent').innerHTML = '<div class="loading">Loading mood trends...</div>';
    document.getElementById('patternsContent').innerHTML = '<div class="loading">Loading patterns...</div>';
    document.getElementById('recommendationsContent').innerHTML = '<div class="loading">Loading recommendations...</div>';
    
    // Load all analytics
    await Promise.all([
        loadRiskAssessment(),
        loadMoodTrends(),
        loadPatterns(),
        loadRecommendations()
    ]);
}

let advancedPatternsLoaded = false;

async function toggleAdvancedPatterns() {
    const section = document.getElementById('advancedPatternsSection');
    const btn = document.getElementById('advancedPatternsBtn');
    const text = document.getElementById('advancedText');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span id="advancedText">Hide Advanced</span>';
        
        if (!advancedPatternsLoaded) {
            await loadAdvancedPatterns();
            advancedPatternsLoaded = true;
        }
    } else {
        section.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-brain"></i> <span id="advancedText">Advanced Insights</span>';
    }
}

async function loadAdvancedPatterns() {
    try {
        const response = await fetch('/api/analytics/advanced-patterns');
        const data = await response.json();
        
        const advancedContent = document.getElementById('advancedPatternsContent');
        
        if (!data.advanced_patterns) {
            advancedContent.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Advanced patterns not available yet.</p>';
            return;
        }
        
        let advancedHTML = '';
        
        // Predictive Insights
        if (data.advanced_patterns.predictive_insights && data.advanced_patterns.predictive_insights.length > 0) {
            advancedHTML += `
                <div style="margin-bottom: 2rem;">
                    <h5 style="color: var(--primary); margin-bottom: 1rem;">
                        <i class="fas fa-crystal-ball"></i> Predictive Insights
                    </h5>
                    <div style="display: grid; gap: 1rem;">
                        ${data.advanced_patterns.predictive_insights.map(insight => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${getInsightColor(insight.type)};">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: var(--text);">${insight.message}</span>
                                    <span style="font-size: 0.8rem; color: var(--text-muted); background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                        ${insight.confidence} confidence
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Correlation Analysis
        if (data.advanced_patterns.correlation_analysis && data.advanced_patterns.correlation_analysis.length > 0) {
            advancedHTML += `
                <div style="margin-bottom: 2rem;">
                    <h5 style="color: var(--secondary); margin-bottom: 1rem;">
                        <i class="fas fa-link"></i> Factor Correlations
                    </h5>
                    <div style="display: grid; gap: 1rem;">
                        ${data.advanced_patterns.correlation_analysis.map(correlation => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--secondary);">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                                    ${correlation.message}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    Correlation strength: ${correlation.strength}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Behavioral Trends
        if (data.advanced_patterns.behavioral_trends && data.advanced_patterns.behavioral_trends.length > 0) {
            advancedHTML += `
                <div style="margin-bottom: 2rem;">
                    <h5 style="color: var(--info); margin-bottom: 1rem;">
                        <i class="fas fa-chart-line"></i> Behavioral Trends
                    </h5>
                    <div style="display: grid; gap: 1rem;">
                        ${data.advanced_patterns.behavioral_trends.map(trend => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--info);">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                                    ${trend.message}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    Timeframe: ${trend.timeframe}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Risk Indicators
        if (data.advanced_patterns.risk_indicators && data.advanced_patterns.risk_indicators.length > 0) {
            advancedHTML += `
                <div style="margin-bottom: 2rem;">
                    <h5 style="color: var(--danger); margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i> Risk Indicators
                    </h5>
                    <div style="display: grid; gap: 1rem;">
                        ${data.advanced_patterns.risk_indicators.map(risk => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${getRiskColor(risk.level)};">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                                    ${risk.message}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                                    ${risk.recommendation}
                                </div>
                                <div style="font-size: 0.8rem; color: ${getRiskColor(risk.level)}; font-weight: 600;">
                                    ${risk.level.toUpperCase()} PRIORITY
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Wellness Opportunities
        if (data.advanced_patterns.wellness_opportunities && data.advanced_patterns.wellness_opportunities.length > 0) {
            advancedHTML += `
                <div style="margin-bottom: 2rem;">
                    <h5 style="color: var(--success); margin-bottom: 1rem;">
                        <i class="fas fa-lightbulb"></i> Wellness Opportunities
                    </h5>
                    <div style="display: grid; gap: 1rem;">
                        ${data.advanced_patterns.wellness_opportunities.map(opportunity => `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--success);">
                                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                                    ${opportunity.message}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-muted);">
                                    Benefit: ${opportunity.benefit}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        if (!advancedHTML) {
            advancedHTML = '<p style="text-align: center; color: var(--text-muted);">Continue tracking to unlock advanced insights!</p>';
        }
        
        advancedContent.innerHTML = advancedHTML;
        
    } catch (error) {
        document.getElementById('advancedPatternsContent').innerHTML = '<p style="color: #e74c3c;">Failed to load advanced patterns</p>';
    }
}

function getInsightColor(type) {
    const colors = {
        'positive_trend': '#00b894',
        'declining_trend': '#e17055',
        'stable_trend': '#74b9ff'
    };
    return colors[type] || '#74b9ff';
}

function getRiskColor(level) {
    const colors = {
        'high': '#e17055',
        'moderate': '#fdcb6e',
        'low': '#00b894'
    };
    return colors[level] || '#74b9ff';
}

// Load analytics on page load
document.addEventListener('DOMContentLoaded', () => {
    refreshAnalytics();
});
</script>

<style>
.loading {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    padding: 2rem;
}

.risk-level.low {
    border-left-color: #00b894;
    background: linear-gradient(135deg, rgba(0, 184, 148, 0.1), rgba(0, 184, 148, 0.05));
}

.risk-level.medium {
    border-left-color: #fdcb6e;
    background: linear-gradient(135deg, rgba(253, 203, 110, 0.15), rgba(253, 203, 110, 0.08));
}

.risk-level.high {
    border-left-color: #e17055;
    background: linear-gradient(135deg, rgba(225, 112, 85, 0.15), rgba(225, 112, 85, 0.08));
}
</style>

{% endblock %}