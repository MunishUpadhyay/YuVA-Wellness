{% extends "base.html" %}
{% block title %}Personal Journal - YuVA Wellness{% endblock %}

{% block content %}
<div class="card">
    <h2>üìù Personal Journal</h2>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">Your private space to reflect, express, and track your thoughts and feelings.</p>
    
    <div class="row" style="margin-bottom: 1rem;">
        <input type="text" id="journal-title" placeholder="Entry title (optional)" style="flex: 1;" />
        <input type="date" id="journal-date" style="width: auto;" />
    </div>
    
    <textarea id="journal-content" placeholder="How are you feeling today? What's on your mind? Write freely without judgment..." 
              style="width: 100%; min-height: 300px; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; 
                     background: var(--bg); color: var(--text); font-family: inherit; font-size: 1rem; resize: vertical;"></textarea>
    
    <div class="row" style="margin-top: 1rem; justify-content: space-between;">
        <div>
            <button class="btn secondary" onclick="saveEntry()">üíæ Save Entry</button>
            <button class="btn secondary" onclick="clearForm()">üóëÔ∏è Clear</button>
        </div>
        <button class="btn" onclick="toggleHistory()">üìö View History</button>
    </div>
    
    <div id="journal-history" style="display: none; margin-top: 2rem;">
        <h3>Your Journal Entries</h3>
        <div id="entries-list"></div>
    </div>
</div>

<script>
let allEntries = [];

async function saveEntry() {
    const title = document.getElementById('journal-title').value;
    const content = document.getElementById('journal-content').value;
    const date = document.getElementById('journal-date').value;
    
    if (!content.trim()) {
        alert('Please write something!');
        return;
    }
    
    try {
        const response = await fetch('/api/journal', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, content, entry_date: date})
        });
        
        if (response.ok) {
            alert('Entry saved successfully!');
            clearForm();
            if (document.getElementById('journal-history').style.display !== 'none') {
                loadHistory();
            }
        } else {
            alert('Failed to save entry');
        }
    } catch (error) {
        alert('Error saving entry');
    }
}

function clearForm() {
    document.getElementById('journal-title').value = '';
    document.getElementById('journal-content').value = '';
    document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
}

async function toggleHistory() {
    const historyDiv = document.getElementById('journal-history');
    const button = event.target;
    
    if (historyDiv.style.display === 'none') {
        await loadHistory();
        historyDiv.style.display = 'block';
        button.textContent = 'üìñ Hide History';
    } else {
        historyDiv.style.display = 'none';
        button.textContent = 'üìö View History';
    }
}

async function loadHistory() {
    try {
        const response = await fetch('/api/journal');
        const entries = await response.json();
        allEntries = entries;
        
        const entriesList = document.getElementById('entries-list');
        
        if (entries.length === 0) {
            entriesList.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No journal entries yet. Start writing!</p>';
            return;
        }
        
        entriesList.innerHTML = entries.map(entry => `
            <div class="entry-card" style="border: 1px solid var(--border-color); padding: 1rem; margin: 1rem 0; border-radius: 8px; background: var(--bg-card);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0; color: var(--primary);">${entry.title || 'Untitled'}</h4>
                    <div>
                        <button onclick="editEntry(${entry.id})" style="background: none; border: none; color: var(--primary); cursor: pointer; margin-right: 0.5rem;" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteEntry(${entry.id})" style="background: none; border: none; color: #e74c3c; cursor: pointer;" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">
                    <i class="fas fa-calendar"></i> ${entry.date}
                </p>
                <div id="content-${entry.id}" style="line-height: 1.6; margin-top: 1rem;">
                    <div style="white-space: pre-wrap;">${truncateText(entry.content, 200)}</div>
                    ${entry.content.length > 200 ? `
                        <button onclick="toggleReadMore(${entry.id})" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 0.5rem; font-size: 0.9rem;">
                            Read more...
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        document.getElementById('entries-list').innerHTML = '<p style="color: #e74c3c;">Failed to load entries</p>';
    }
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

function toggleReadMore(entryId) {
    const contentDiv = document.getElementById(`content-${entryId}`);
    const entry = allEntries.find(e => e.id === entryId);
    
    if (!entry) return;
    
    const button = contentDiv.querySelector('button');
    const isExpanded = button && button.textContent.trim() === 'Show less';
    
    if (isExpanded) {
        contentDiv.innerHTML = `
            <div style="white-space: pre-wrap;">${truncateText(entry.content, 200)}</div>
            <button onclick="toggleReadMore(${entryId})" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 0.5rem; font-size: 0.9rem;">
                Read more...
            </button>
        `;
    } else {
        contentDiv.innerHTML = `
            <div style="white-space: pre-wrap;">${entry.content}</div>
            <button onclick="toggleReadMore(${entryId})" style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 0.5rem; font-size: 0.9rem;">
                Show less
            </button>
        `;
    }
}

function editEntry(id) {
    const entry = allEntries.find(e => e.id === id);
    if (entry) {
        document.getElementById('journal-title').value = entry.title || '';
        document.getElementById('journal-content').value = entry.content || '';
        document.getElementById('journal-date').value = entry.date || '';
        window.scrollTo({top: 0, behavior: 'smooth'});
        alert('Entry loaded for editing');
    }
}

async function deleteEntry(id) {
    if (!confirm('Are you sure you want to delete this entry?')) return;
    
    try {
        const response = await fetch(`/api/journal/${id}`, {method: 'DELETE'});
        if (response.ok) {
            alert('Entry deleted');
            loadHistory();
        } else {
            alert('Failed to delete entry');
        }
    } catch (error) {
        alert('Error deleting entry');
    }
}

// Set today's date on load
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
});
</script>

{% endblock %}